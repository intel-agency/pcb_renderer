name: Platform Smoke Tests

on:
  push:
    branches: [ master, development, nam20485 ]
  pull_request:
  workflow_dispatch:

jobs:
  docker-linux-alpine:
    name: Docker Smoke Test (Alpine Linux)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0

      - name: Build and run Alpine Linux smoke tests
        run: |
          docker build -t pcb-renderer-test:linux-alpine -f Dockerfile.test.linux .
          docker run --rm pcb-renderer-test:linux-alpine

  docker-linux-debian:
    name: Docker Smoke Test (Debian/Ubuntu)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0

      - name: Build and run Debian/Ubuntu smoke tests
        run: |
          docker build -t pcb-renderer-test:linux-debian -f Dockerfile.test.debian .
          docker run --rm pcb-renderer-test:linux-debian

  docker-windows:
    name: Docker Smoke Test (Windows)
    runs-on: windows-2022
    
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Build and run Windows smoke tests
        run: |
          docker build -t pcb-renderer-test:windows -f Dockerfile.test.windows .
          docker run --rm pcb-renderer-test:windows
        shell: powershell

  macos-native:
    name: Native Smoke Test (macOS)
    runs-on: macos-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Setup Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: '3.11'

      - name: Install uv
        run: pip install uv

      - name: Sync dependencies
        run: uv sync --all-extras

      - name: Run macOS smoke tests
        run: |
          echo "=== Running macOS Native Smoke Tests ==="
          echo ""
          echo "1. Testing basic render..."
          uv run pcb-render boards/board_alpha.json -o /tmp/test_alpha.svg
          echo "   ✓ Basic render successful"
          echo ""
          echo "2. Testing PNG export..."
          uv run pcb-render boards/board.json -o /tmp/test.png --format png --permissive
          echo "   ✓ PNG export successful"
          echo ""
          echo "3. Testing validation errors..."
          uv run pcb-render boards/board_theta.json -o /tmp/test_theta.svg --permissive
          echo "   ✓ Validation with permissive mode successful"
          echo ""
          echo "4. Testing export JSON..."
          uv run pcb-render boards/board.json -o /tmp/test.svg --export-json /tmp/export.json --permissive
          echo "   ✓ Export JSON successful"
          echo ""
          echo "5. Running full test suite..."
          uv run pytest --cov
          echo "   ✓ Test suite passed"
          echo ""
          echo "=== All macOS Smoke Tests Passed ==="
